/**
 * Created by Tw93 on 2017/1/31.
 */
window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;document.addEventListener("DOMContentLoaded",function(){var zoomImgs=Array.prototype.slice.call(document.querySelectorAll(".entry-content img"));if(zoomImgs.length>0&&isPC()){loadScript("https://gw.alipayobjects.com/os/k/s3/lightense.min.js",function(){if(typeof Lightense==="undefined")return;var activeIndex=-1;var activeTarget=null;var activeBase=null;var isNavigating=false;var queuedIndex=null;var stripOssProcess=function(url){if(!url||typeof url!=="string"||url.indexOf("x-oss-process=")===-1)return url;var hashIndex=url.indexOf("#");var hash=hashIndex>=0?url.slice(hashIndex):"";var beforeHash=hashIndex>=0?url.slice(0,hashIndex):url;var queryIndex=beforeHash.indexOf("?");if(queryIndex===-1)return url;var base=beforeHash.slice(0,queryIndex);var query=beforeHash.slice(queryIndex+1);var params=query.split("&").filter(function(param){return param&&param.indexOf("x-oss-process=")!==0});var cleaned=params.length?base+"?"+params.join("&"):base;return cleaned+hash};var getOriginalSrc=function(img){var dataSrc=img.getAttribute("data-lightense-src");var candidate=dataSrc||img.currentSrc||img.src;return stripOssProcess(candidate)};var swapToOriginal=function(target){var zoomSrc=getOriginalSrc(target);if(!zoomSrc||target.src===zoomSrc)return;target.setAttribute("data-lightense-src-current",target.src);target.src=zoomSrc};var restoreCompressed=function(target){var compressedSrc=target.getAttribute("data-lightense-src-current");if(!compressedSrc)return;target.src=compressedSrc;target.removeAttribute("data-lightense-src-current")};var getZoomSrc=function(img){return getOriginalSrc(img)};var getScrollOffsets=function(){return{x:window.pageXOffset||document.documentElement.scrollLeft||0,y:window.pageYOffset||document.documentElement.scrollTop||0}};var getCurrentScale=function(img){var transform=img.style.transform||"";var match=transform.match(/scale\(([^)]+)\)/);var value=match?parseFloat(match[1]):NaN;return isFinite(value)?value:1};var getLayoutSize=function(img){var width=img.width||img.clientWidth;var height=img.height||img.clientHeight;if(width&&height)return{width:width,height:height};var rect=img.getBoundingClientRect();var scale=getCurrentScale(img);return{width:scale?rect.width/scale:rect.width,height:scale?rect.height/scale:rect.height}};var disableTransition=function(el){if(!el)return null;var previous=el.style.transition;el.style.transition="none";return previous};var restoreTransition=function(el,previous){if(!el)return;el.style.transition=previous||""};var waitForImage=function(img,callback){if(img.complete&&img.naturalWidth){callback();return}var loaded=function(){img.removeEventListener("load",loaded);img.removeEventListener("error",loaded);callback()};img.addEventListener("load",loaded);img.addEventListener("error",loaded)};var computeScale=function(img){var size=getLayoutSize(img);var rectWidth=size.width;var rectHeight=size.height;var naturalWidth=img.naturalWidth;var naturalHeight=img.naturalHeight;if(!rectWidth||!rectHeight||!naturalWidth||!naturalHeight)return 1;var paddingAttr=img.getAttribute("data-lightense-padding")||img.getAttribute("data-padding");var padding=parseFloat(paddingAttr);var effectivePadding=isFinite(padding)?padding:40;var viewportWidth=window.innerWidth||document.documentElement.clientWidth||0;var viewportHeight=window.innerHeight||document.documentElement.clientHeight||0;var availableWidth=viewportWidth>effectivePadding?viewportWidth-effectivePadding:viewportWidth;var availableHeight=viewportHeight>effectivePadding?viewportHeight-effectivePadding:viewportHeight;var scaleToNatural=naturalWidth/rectWidth;if(naturalWidth<availableWidth&&naturalHeight<availableHeight){return scaleToNatural}var imgRatio=naturalWidth/naturalHeight;var viewportRatio=availableWidth/availableHeight;return imgRatio<viewportRatio?availableHeight/rectHeight:availableWidth/rectWidth};var updateWrapTransform=function(img){if(!activeBase||!activeTarget)return;var wrap=activeTarget.parentElement;if(!wrap||wrap.className.indexOf("lightense-wrap")===-1)return;var size=getLayoutSize(img);var width=size.width;var height=size.height;if(!width||!height)return;var offsets=getScrollOffsets();var viewportWidth=window.innerWidth||document.documentElement.clientWidth||0;var viewportHeight=window.innerHeight||document.documentElement.clientHeight||0;var centerX=offsets.x+viewportWidth/2;var centerY=offsets.y+viewportHeight/2;var translateX=Math.round(centerX-(activeBase.left+width/2));var translateY=Math.round(centerY-(activeBase.top+height/2));wrap.style.transform="translate3d("+translateX+"px, "+translateY+"px, 0)"};var updateActiveImage=function(nextIndex,callback){if(!activeTarget)return;var nextImg=zoomImgs[nextIndex];if(!nextImg)return;var nextSrc=getZoomSrc(nextImg);if(!nextSrc)return;var wrap=activeTarget.parentElement&&activeTarget.parentElement.className.indexOf("lightense-wrap")!==-1?activeTarget.parentElement:null;var targetTransition=disableTransition(activeTarget);var wrapTransition=disableTransition(wrap);activeTarget.src=nextSrc;waitForImage(activeTarget,function(){var scale=computeScale(activeTarget);activeTarget.style.transform="scale("+scale+")";updateWrapTransform(activeTarget);void activeTarget.offsetHeight;restoreTransition(activeTarget,targetTransition);restoreTransition(wrap,wrapTransition);activeIndex=nextIndex;if(callback)callback()})};var navigateTo=function(nextIndex){if(isNavigating){queuedIndex=nextIndex;return}isNavigating=true;updateActiveImage(nextIndex,function(){isNavigating=false;if(queuedIndex!==null&&queuedIndex!==nextIndex){var targetIndex=queuedIndex;queuedIndex=null;navigateTo(targetIndex)}else{queuedIndex=null}})};Lightense(zoomImgs,{background:"rgba(230, 230, 230, 0.85)",beforeShow:function(data){var target=data.target;activeTarget=target;activeIndex=zoomImgs.indexOf(target);initialIndex=activeIndex;var rect=target.getBoundingClientRect();var offsets=getScrollOffsets();activeBase={left:rect.left+offsets.x,top:rect.top+offsets.y,width:rect.width,height:rect.height,borderRadius:getComputedStyle(target).borderRadius};swapToOriginal(target)},beforeHide:function(data){if(activeIndex!==initialIndex&&activeTarget){
// 1. Hide the default animation (which flies back to A)
activeTarget.style.transition="none";activeTarget.style.opacity="0";var wrap=activeTarget.parentElement;if(wrap&&wrap.className.indexOf("lightense-wrap")!==-1){wrap.style.transition="none";wrap.style.opacity="0"}
// 2. Filler: Restore Image A at original position
var filler=document.createElement("img");filler.src=activeTarget.getAttribute("data-lightense-src-current")||activeTarget.src;filler.style.position="absolute";filler.style.left=activeBase.left+"px";filler.style.top=activeBase.top+"px";filler.style.width=activeBase.width+"px";filler.style.height=activeBase.height+"px";filler.style.borderRadius=activeBase.borderRadius;filler.style.objectFit="cover";filler.style.margin="0";filler.style.padding="0";filler.style.zIndex="1";// Ensure visible
filler.id="lightense-filler";document.body.appendChild(filler);
// 3. Ghost: Animate using Transform for performance
var ghost=activeTarget.cloneNode(true);var rectZ=activeTarget.getBoundingClientRect();// Current Zoomed Rect
ghost.className="";// Clear Lightense classes
ghost.style.position="fixed";ghost.style.left=rectZ.left+"px";ghost.style.top=rectZ.top+"px";ghost.style.width=rectZ.width+"px";ghost.style.height=rectZ.height+"px";ghost.style.transformOrigin="0 0";// Important for scale
ghost.style.transform="";ghost.style.zIndex="2147483647";// Max Z
ghost.style.transition="transform 300ms cubic-bezier(0.2, 0, 0.2, 1), border-radius 300ms cubic-bezier(0.2, 0, 0.2, 1)";ghost.style.borderRadius=activeBase.borderRadius;ghost.id="lightense-ghost";document.body.appendChild(ghost);
// Calculate Destination & Deltas
var currentImg=zoomImgs[activeIndex];var rectB=currentImg.getBoundingClientRect();var scaleX=rectB.width/rectZ.width;var scaleY=rectB.height/rectZ.height;var tx=rectB.left-rectZ.left;var ty=rectB.top-rectZ.top;
// Force reflow
void ghost.offsetWidth;
// Apply Transform Animation
ghost.style.transform="translate3d("+tx+"px, "+ty+"px, 0) scale("+scaleX+", "+scaleY+")";ghost.style.borderRadius=getComputedStyle(currentImg).borderRadius;
// Auto-cleanup Ghost
setTimeout(function(){if(ghost.parentNode)ghost.parentNode.removeChild(ghost)},300)}},afterHide:function(data){var target=data.target;
// Cleanup Filler
var filler=document.getElementById("lightense-filler");if(filler)filler.parentNode.removeChild(filler);
// Cleanup Ghost (just in case)
var ghost=document.getElementById("lightense-ghost");if(ghost)ghost.parentNode.removeChild(ghost);if(activeIndex!==initialIndex){
// Reset styles for next use
target.style.transition="";target.style.opacity="";var wrap=target.parentElement;if(wrap&&wrap.className.indexOf("lightense-wrap")!==-1){wrap.style.transition="";wrap.style.opacity=""}}restoreCompressed(target);activeTarget=null;activeIndex=-1;initialIndex=-1;activeBase=null;isNavigating=false;queuedIndex=null}});document.addEventListener("keydown",function(event){var keys=["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"];if(keys.indexOf(event.key)===-1)return;if(!activeTarget||activeTarget.className.indexOf("lightense-open")===-1)return;event.preventDefault();if(activeIndex===-1)return;var isPrev=event.key==="ArrowLeft"||event.key==="ArrowUp";var nextIndex=isPrev?(activeIndex-1+zoomImgs.length)%zoomImgs.length:(activeIndex+1)%zoomImgs.length;navigateTo(nextIndex)})})}if(!isPC()){return}var beforeScrollTop=document.documentElement.scrollTop;document.addEventListener("scroll",function(){var afterScrollTop=document.documentElement.scrollTop;var delta=afterScrollTop-beforeScrollTop;document.getElementById("J_header").setAttribute("class",delta>0&&afterScrollTop>0?"header-menu header-menu-overflow":"header-menu");beforeScrollTop=afterScrollTop});var width=window.innerWidth;var height=260;var canvas=document.getElementById("J_firework_canvas");if(!canvas)return;// Guard against missing canvas
canvas.width=width;canvas.height=height;var ctx=canvas.getContext("2d",{alpha:true});var points=[];var isAnimating=true;var mouse={x:0,y:9999};
// Pause animation when canvas is not visible
if("IntersectionObserver"in window){var observer=new IntersectionObserver(function(entries){entries.forEach(function(entry){isAnimating=entry.isIntersecting})},{threshold:0});observer.observe(canvas)}function Point(x,y,speed,width,color){this.x=x;this.y=y;this.width=width;this.color=color;this.alpha=Math.random()-.1;this.speed=speed;this.active=true;this.physx=function(){this.y+=this.speed;if(this.y>canvas.height)this.kill()};this.kill=function(){points.splice(points.indexOf(this),1);this.active=false};this.draw=function(){ctx.beginPath();ctx.arc(this.x,this.y,this.width,0,Math.PI*2,true);ctx.fillStyle=this.color;ctx.lineWidth=this.width;ctx.save();ctx.globalAlpha=this.alpha;ctx.fill();ctx.restore()}}function drawFirework(){if(!isAnimating){requestAnimationFrame(drawFirework);return}ctx.clearRect(0,0,canvas.width,canvas.height);
// Only create new points if mouse is in active area
if(mouse.y<height){for(var i=0;i<5;i++){var posX=mouse.x+Math.random()*10;var posY=mouse.y+Math.random()*10;points.push(new Point(posX,posY,1+Math.random()*2,5,"white"))}}for(var i in points){if(points[i].active){points[i].draw();points[i].physx()}}requestAnimationFrame(drawFirework)}
// Check for prefers-reduced-motion
var prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches;if(!prefersReducedMotion){drawFirework()}document.onmousemove=function(e){mouse.x=e.pageX;mouse.y=e.pageY};document.onmouseout=function(e){mouse.x=0;mouse.y=9999};var qrTextEl=document.getElementById("J_qr_text");var isShowQr=qrTextEl&&qrTextEl.offsetParent;isShowQr&&loadScript("https://gw.alipayobjects.com/os/k/qa/qrcode.min.js",function(){QRCode&&new QRCode(document.getElementById("J_qr_code"),{width:128,height:128,useSVG:true,text:window.location.href,correctLevel:QRCode.CorrectLevel.L})})},false);function isPC(){var userAgentInfo=navigator.userAgent;var Agents=["Android","iPhone","Windows Phone","iPad","iPod"];var flag=true;for(var v=0;v<Agents.length;v++){if(userAgentInfo.indexOf(Agents[v])>0){flag=false;break}}return flag}function loadScript(url,callback){var script=document.createElement("script");script.type="text/javascript";if(script.readyState){script.onreadystatechange=function(){if(script.readyState=="loaded"||script.readyState=="complete"){script.onreadystatechange=null;callback()}}}else{script.onload=function(){callback()}}script.src=url;document.body.appendChild(script)}